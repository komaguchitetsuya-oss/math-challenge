<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã•ãƒ¼ã¡ã‚ƒã‚“è¨ˆç®—ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{
    --primary:#4f46e5;--primary-hover:#4338ca;
    --success:#16a34a;--danger:#dc2626;--warning:#ea580c;
    --bg:#f8fafc;--card:#fff;--text:#1e293b;--muted:#64748b;
    --radius:12px;
  }
  body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Hiragino Kaku Gothic ProN',sans-serif;
    background:var(--bg);color:var(--text);
    min-height:100dvh;display:flex;align-items:center;justify-content:center;
    padding:16px;
  }
  .screen{display:none;width:100%;max-width:480px;text-align:center}
  .screen.active{display:block}
  h1{font-size:2rem;margin-bottom:8px}
  h2{font-size:1.5rem;margin-bottom:16px}
  .subtitle{color:var(--muted);margin-bottom:24px;font-size:.95rem}
  .btn{
    display:inline-block;padding:14px 32px;border:none;border-radius:var(--radius);
    font-size:1.1rem;font-weight:600;cursor:pointer;transition:all .15s;
    text-decoration:none;color:#fff;min-width:200px;
  }
  .btn-primary{background:var(--primary)}
  .btn-primary:hover{background:var(--primary-hover)}
  .btn-success{background:var(--success)}
  .btn-danger{background:var(--danger)}
  .btn-warning{background:var(--warning)}
  .btn-outline{
    background:transparent;color:var(--primary);border:2px solid var(--primary);
  }
  .btn-outline:hover{background:var(--primary);color:#fff}
  .btn+.btn{margin-top:12px}
  .btn-group{display:flex;flex-direction:column;align-items:center;gap:12px}

  .mode-desc{font-size:.75rem;font-weight:400;opacity:.85;display:block;margin-top:2px}
  .mode-label{font-size:.85rem;color:var(--muted);margin-bottom:4px}

  /* Mode tabs */
  .mode-tabs{
    display:flex;gap:6px;justify-content:center;margin-bottom:16px;flex-wrap:wrap;
  }
  .mode-tab{
    padding:6px 14px;border:2px solid var(--primary);border-radius:20px;
    background:transparent;color:var(--primary);font-size:.8rem;font-weight:600;
    cursor:pointer;transition:all .15s;
  }
  .mode-tab.active{background:var(--primary);color:#fff}
  .mode-tab:hover:not(.active){background:rgba(79,70,229,.08)}

  /* Game screen */
  .game-header{
    display:flex;justify-content:space-between;align-items:center;
    margin-bottom:24px;padding:16px;
    background:var(--card);border-radius:var(--radius);
    box-shadow:0 1px 3px rgba(0,0,0,.08);
  }
  .timer{font-size:1.4rem;font-weight:700;color:var(--primary)}
  .timer.danger{color:var(--danger);animation:pulse .5s infinite alternate}
  @keyframes pulse{to{opacity:.5}}
  .score-display{font-size:1.4rem;font-weight:700}
  .question-number{font-size:.9rem;color:var(--muted);margin-bottom:8px}
  .question{
    font-size:2.8rem;font-weight:800;letter-spacing:2px;
    padding:32px 16px;margin-bottom:24px;
    background:var(--card);border-radius:var(--radius);
    box-shadow:0 1px 3px rgba(0,0,0,.08);
  }
  .answer-area{display:flex;gap:12px;justify-content:center;margin-bottom:16px}
  #answerInput{
    font-size:2rem;text-align:center;width:180px;padding:12px;
    border:2px solid #cbd5e1;border-radius:var(--radius);
    outline:none;transition:border-color .15s;
    -moz-appearance:textfield;
  }
  #answerInput::-webkit-outer-spin-button,
  #answerInput::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  #answerInput:focus{border-color:var(--primary)}
  #submitBtn{padding:12px 24px;font-size:1.3rem}
  .feedback{
    font-size:1.2rem;font-weight:700;min-height:40px;
    display:flex;align-items:center;justify-content:center;gap:8px;
    transition:all .2s;
  }
  .feedback.correct{color:var(--success)}
  .feedback.wrong{color:var(--danger)}

  .flash{animation:flash-bg .4s}
  @keyframes flash-bg{
    0%{background:rgba(22,163,74,.15)}
    100%{background:transparent}
  }

  /* Result screen */
  .result-score{font-size:4rem;font-weight:800;color:var(--primary);margin:16px 0}
  .result-rank{font-size:1.2rem;color:var(--muted);margin-bottom:24px}
  .result-detail{color:var(--muted);margin-bottom:8px;font-size:.95rem}

  /* Ranking screen */
  .ranking-list{
    list-style:none;text-align:left;
    background:var(--card);border-radius:var(--radius);
    box-shadow:0 1px 3px rgba(0,0,0,.08);overflow:hidden;
    margin-bottom:24px;
  }
  .ranking-item{
    display:flex;align-items:center;padding:12px 16px;
    border-bottom:1px solid #f1f5f9;
  }
  .ranking-item:last-child{border-bottom:none}
  .ranking-item .rank{
    font-size:1.2rem;font-weight:700;width:40px;
    color:var(--muted);flex-shrink:0;
  }
  .ranking-item .rank.gold{color:#f59e0b}
  .ranking-item .rank.silver{color:#94a3b8}
  .ranking-item .rank.bronze{color:#b45309}
  .ranking-item .info{flex:1}
  .ranking-item .info .date{font-size:.8rem;color:var(--muted)}
  .ranking-item .score-val{font-size:1.3rem;font-weight:700;color:var(--primary)}
  .empty-message{color:var(--muted);padding:32px 16px}

  /* Chart screen */
  .chart-container{
    background:var(--card);border-radius:var(--radius);
    box-shadow:0 1px 3px rgba(0,0,0,.08);
    padding:16px;margin-bottom:24px;
  }

  /* Wrong list */
  .wrong-item{
    display:flex;align-items:center;padding:12px 16px;
    border-bottom:1px solid #f1f5f9;gap:8px;
  }
  .wrong-item:last-child{border-bottom:none}
  .wrong-item .problem-text{flex:1;font-size:1rem;font-weight:600;text-align:left}
  .wrong-item .wrong-answer{font-size:.85rem;color:var(--danger);text-align:right}
  .wrong-item .correct-answer{font-size:.85rem;color:var(--success);text-align:right}
  .wrong-item .wrong-date{font-size:.75rem;color:var(--muted);text-align:left}
  .wrong-item .wrong-delete{
    background:none;border:none;color:var(--muted);font-size:1.1rem;cursor:pointer;
    padding:4px 8px;border-radius:4px;
  }
  .wrong-item .wrong-delete:hover{color:var(--danger);background:#fee2e2}

  /* Game over overlay */
  .game-over-reason{
    font-size:1.1rem;color:var(--muted);margin-bottom:8px;
  }

  /* Numpad */
  .numpad{
    display:none;
    grid-template-columns:repeat(3,1fr);
    gap:8px;max-width:320px;margin:0 auto 16px;
  }
  .numpad-btn{
    padding:14px 0;font-size:1.5rem;font-weight:700;
    border:none;border-radius:var(--radius);cursor:pointer;
    background:var(--card);color:var(--text);
    box-shadow:0 1px 3px rgba(0,0,0,.1);
    transition:background .1s;
    -webkit-tap-highlight-color:transparent;
    user-select:none;
  }
  .numpad-btn:active{background:#e2e8f0}
  .numpad-btn.key-0{grid-column:2/3}
  .numpad-btn.key-del{background:#fee2e2;color:var(--danger)}
  .numpad-btn.key-ok{grid-column:1/-1;background:var(--primary);color:#fff;padding:16px 0}
  .numpad-btn.key-ok:active{background:var(--primary-hover)}

  /* Mobile: show numpad, hide OK button next to input */
  @media (hover:none) and (pointer:coarse){
    .numpad{display:grid}
    #submitBtn{display:none}
    #answerInput{caret-color:var(--primary)}
  }

  /* Small screen adjustments */
  @media (max-width:480px){
    body{padding:8px;align-items:flex-start;padding-top:16px}
    h1{font-size:1.6rem}
    .question{font-size:2.2rem;padding:20px 12px;margin-bottom:16px}
    #answerInput{font-size:1.6rem;width:150px;padding:10px}
    .game-header{padding:12px;margin-bottom:16px}
    .result-score{font-size:3rem}
  }
</style>
</head>
<body>

<!-- Start Screen -->
<div id="startScreen" class="screen active">
  <h1>ã•ãƒ¼ã¡ã‚ƒã‚“è¨ˆç®—ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h1>
  <p class="subtitle">åˆ¶é™æ™‚é–“å†…ã«ã©ã‚Œã ã‘é€£ç¶šæ­£è§£ã§ãã‚‹ã‹æŒ‘æˆ¦ã—ã‚ˆã†ï¼<br>æ­£è§£ã™ã‚‹ãŸã³ã« +5ç§’</p>
  <p style="color:var(--muted);margin-bottom:12px;font-size:.9rem">ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã‚¹ã‚¿ãƒ¼ãƒˆ</p>
  <div class="btn-group">
    <button class="btn btn-primary" onclick="selectMode('random')">ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰<span class="mode-desc">æ•´æ•°ï¼‹å°æ•°ã®æ··åˆå•é¡Œ</span></button>
    <button class="btn btn-success" onclick="selectMode('easyDec')">ã‚„ã•ã—ã„å°æ•°ãƒ¢ãƒ¼ãƒ‰<span class="mode-desc">å°æ•°ã®ã¿ãƒ»ã‹ã‘ç®—ã‹ã‚“ãŸã‚“</span></button>
    <button class="btn btn-warning" onclick="selectMode('hardDec')">é›£ã—ã„å°æ•°ãƒ¢ãƒ¼ãƒ‰<span class="mode-desc">å°æ•°ã®ã¿ãƒ»ã‹ã‘ç®—ã‚€ãšã‹ã—ã„</span></button>
    <button class="btn btn-danger" id="reviewModeBtn" onclick="selectMode('review')" style="display:none">å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰<span class="mode-desc">ã¾ã¡ãŒãˆãŸå•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§å‡ºé¡Œ</span></button>
    <button class="btn btn-outline" onclick="showScreen('rankingScreen')">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
    <button class="btn btn-outline" onclick="showScreen('chartScreen')">æˆç¸¾æ¨ç§»</button>
    <button class="btn btn-outline" onclick="showScreen('wrongListScreen')">ã¾ã¡ãŒãˆãŸå•é¡Œ</button>
  </div>
</div>

<!-- Game Screen -->
<div id="gameScreen" class="screen">
  <div id="gameModeLabel" class="mode-label"></div>
  <div class="game-header">
    <div><span style="font-size:.85rem;color:var(--muted)">æ®‹ã‚Šæ™‚é–“</span><br><span id="timer" class="timer">60.0</span></div>
    <div><span style="font-size:.85rem;color:var(--muted)">é€£ç¶šæ­£è§£</span><br><span id="scoreDisplay" class="score-display">0</span></div>
  </div>
  <div class="question-number">ç¬¬ <span id="questionNum">1</span> å•</div>
  <div id="questionBox" class="question">12 + 34</div>
  <div class="answer-area">
    <input type="text" id="answerInput" inputmode="decimal" pattern="[0-9.]*" autocomplete="off" placeholder="ç­”ãˆ">
    <button id="submitBtn" class="btn btn-primary" onclick="submitAnswer()">OK</button>
  </div>
  <div id="feedback" class="feedback"></div>
  <div class="numpad" id="numpad">
    <button class="numpad-btn" data-key="1">1</button>
    <button class="numpad-btn" data-key="2">2</button>
    <button class="numpad-btn" data-key="3">3</button>
    <button class="numpad-btn" data-key="4">4</button>
    <button class="numpad-btn" data-key="5">5</button>
    <button class="numpad-btn" data-key="6">6</button>
    <button class="numpad-btn" data-key="7">7</button>
    <button class="numpad-btn" data-key="8">8</button>
    <button class="numpad-btn" data-key="9">9</button>
    <button class="numpad-btn key-del" data-key="del">&#x232B;</button>
    <button class="numpad-btn key-0" data-key="0">0</button>
    <button class="numpad-btn" data-key=".">.</button>
    <button class="numpad-btn key-ok" data-key="ok">OK</button>
  </div>
</div>

<!-- Result Screen -->
<div id="resultScreen" class="screen">
  <h2>ã‚²ãƒ¼ãƒ çµ‚äº†</h2>
  <div id="gameOverReason" class="game-over-reason"></div>
  <div class="result-score" id="resultScore">0</div>
  <div class="result-detail">é€£ç¶šæ­£è§£</div>
  <div class="result-rank" id="resultRank"></div>
  <div class="btn-group">
    <button class="btn btn-primary" onclick="startGame()">ã‚‚ã†ä¸€åº¦</button>
    <button class="btn btn-outline" onclick="showScreen('rankingScreen')">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
    <button class="btn btn-outline" onclick="showScreen('startScreen')">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
  </div>
</div>

<!-- Ranking Screen -->
<div id="rankingScreen" class="screen">
  <h2>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
  <div class="mode-tabs" id="rankingTabs"></div>
  <ul id="rankingList" class="ranking-list"></ul>
  <button class="btn btn-outline" onclick="showScreen('startScreen')">æˆ»ã‚‹</button>
</div>

<!-- Wrong List Screen -->
<div id="wrongListScreen" class="screen">
  <h2>ã¾ã¡ãŒãˆãŸå•é¡Œ</h2>
  <div id="wrongCount" style="color:var(--muted);font-size:.9rem;margin-bottom:12px"></div>
  <ul id="wrongList" class="ranking-list"></ul>
  <div class="btn-group">
    <button class="btn btn-danger" id="clearWrongBtn" onclick="clearWrongProblems()" style="display:none">ã™ã¹ã¦å‰Šé™¤</button>
    <button class="btn btn-outline" onclick="showScreen('startScreen')">æˆ»ã‚‹</button>
  </div>
</div>

<!-- Chart Screen -->
<div id="chartScreen" class="screen">
  <h2>æˆç¸¾æ¨ç§»</h2>
  <div class="mode-tabs" id="chartTabs"></div>
  <div class="chart-container">
    <canvas id="historyChart"></canvas>
  </div>
  <button class="btn btn-outline" onclick="showScreen('startScreen')">æˆ»ã‚‹</button>
</div>

<script>
// ==============================
// State
// ==============================
let timeLeft = 0;
let score = 0;
let currentAnswer = 0;
let timerInterval = null;
let gameActive = false;
let historyChart = null;
let currentMode = 'random';
let rankingViewMode = 'random';
let chartViewMode = 'random';
const isTouchDevice = window.matchMedia('(hover:none) and (pointer:coarse)').matches;

const MODE_NAMES = { random: 'ãƒ©ãƒ³ãƒ€ãƒ ', easyDec: 'ã‚„ã•ã—ã„å°æ•°', hardDec: 'é›£ã—ã„å°æ•°', review: 'å¾©ç¿’' };
const STORAGE_KEYS = { random: 'mathGameHistory_random', easyDec: 'mathGameHistory_easyDec', hardDec: 'mathGameHistory_hardDec', review: 'mathGameHistory_review' };
const WRONG_KEY = 'mathWrongProblems';
let currentDisplay = '';  // track current problem display for wrong answer logging
let reviewPool = [];  // pool of wrong problems for review mode

// ==============================
// Screen management
// ==============================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (id === 'rankingScreen') { rankingViewMode = currentMode === 'review' ? 'random' : currentMode; renderRankingTabs(); renderRanking(); }
  if (id === 'chartScreen') { chartViewMode = currentMode === 'review' ? 'random' : currentMode; renderChartTabs(); renderChart(); }
  if (id === 'wrongListScreen') { renderWrongList(); }
  if (id === 'startScreen') { updateReviewButton(); }
}

function updateReviewButton() {
  const wrongs = getWrongProblems();
  const btn = document.getElementById('reviewModeBtn');
  btn.style.display = wrongs.length > 0 ? '' : 'none';
  if (wrongs.length > 0) {
    btn.querySelector('.mode-desc').textContent = `ã¾ã¡ãŒãˆãŸ${wrongs.length}å•ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œ`;
  }
}

// ==============================
// Mode tabs
// ==============================
function renderModeTabs(containerId, activeMode, onClick) {
  const container = document.getElementById(containerId);
  container.innerHTML = Object.keys(MODE_NAMES).map(mode =>
    `<button class="mode-tab${mode === activeMode ? ' active' : ''}" data-mode="${mode}">${MODE_NAMES[mode]}</button>`
  ).join('');
  container.querySelectorAll('.mode-tab').forEach(btn => {
    btn.addEventListener('click', () => onClick(btn.dataset.mode));
  });
}

function renderRankingTabs() {
  renderModeTabs('rankingTabs', rankingViewMode, (mode) => {
    rankingViewMode = mode;
    renderRankingTabs();
    renderRanking();
  });
}

function renderChartTabs() {
  renderModeTabs('chartTabs', chartViewMode, (mode) => {
    chartViewMode = mode;
    renderChartTabs();
    renderChart();
  });
}

// ==============================
// History (localStorage) - mode-separated
// ==============================
function getHistory(mode) {
  mode = mode || currentMode;
  const key = STORAGE_KEYS[mode] || STORAGE_KEYS.random;
  try {
    if (!localStorage.getItem(key) && mode === 'random') {
      const old = localStorage.getItem('mathGameHistory');
      if (old) {
        localStorage.setItem(key, old);
        localStorage.removeItem('mathGameHistory');
      }
    }
    return JSON.parse(localStorage.getItem(key) || '[]');
  } catch { return []; }
}

function saveResult(sc) {
  const key = STORAGE_KEYS[currentMode] || STORAGE_KEYS.random;
  const history = getHistory(currentMode);
  history.push({ date: new Date().toISOString(), score: sc });
  localStorage.setItem(key, JSON.stringify(history));
}

// ==============================
// Wrong problems (localStorage)
// ==============================
function getWrongProblems() {
  try { return JSON.parse(localStorage.getItem(WRONG_KEY) || '[]'); } catch { return []; }
}

function saveWrongProblem(display, userAnswer, correctAnswer) {
  const wrongs = getWrongProblems();
  wrongs.push({
    display,
    userAnswer: formatNum(userAnswer),
    correctAnswer: formatNum(correctAnswer),
    date: new Date().toISOString()
  });
  localStorage.setItem(WRONG_KEY, JSON.stringify(wrongs));
}

function removeWrongProblem(index) {
  const wrongs = getWrongProblems();
  wrongs.splice(index, 1);
  localStorage.setItem(WRONG_KEY, JSON.stringify(wrongs));
}

function clearWrongProblems() {
  if (!confirm('ã¾ã¡ãŒãˆãŸå•é¡Œã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  localStorage.removeItem(WRONG_KEY);
  renderWrongList();
}

function renderWrongList() {
  const wrongs = getWrongProblems();
  const list = document.getElementById('wrongList');
  const countEl = document.getElementById('wrongCount');
  const clearBtn = document.getElementById('clearWrongBtn');

  countEl.textContent = `${wrongs.length} å•`;
  clearBtn.style.display = wrongs.length > 0 ? '' : 'none';

  if (wrongs.length === 0) {
    list.innerHTML = '<li class="empty-message">ã¾ã¡ãŒãˆãŸå•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
    return;
  }

  // Show newest first
  list.innerHTML = wrongs.slice().reverse().map((item, ri) => {
    const i = wrongs.length - 1 - ri;
    const d = new Date(item.date);
    const dateStr = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    return `
      <li class="wrong-item">
        <div style="flex:1">
          <div class="problem-text">${item.display} = ?</div>
          <div class="wrong-date">${dateStr}ã€€<span class="wrong-answer">âœ— ${item.userAnswer}</span>ã€€<span class="correct-answer">â†’ ${item.correctAnswer}</span>${item.correctStreak ? `ã€€<span style="color:var(--primary);font-weight:600">ğŸ”¥${item.correctStreak}/10</span>` : ''}</div>
        </div>
        <button class="wrong-delete" onclick="removeWrongProblem(${i});renderWrongList()">âœ•</button>
      </li>`;
  }).join('');
}

// ==============================
// Problem generation
// ==============================
function rand(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function pick(arr) { return arr[rand(0, arr.length - 1)]; }

function roundDec(n) {
  return Math.round(n * 10000) / 10000;
}

function formatNum(n) {
  return String(roundDec(n));
}

function generateProblem(questionNumber) {
  const ops = ['+', '-', 'Ã—', 'Ã·'];
  const op = ops[rand(0, 3)];
  let a, b, answer;

  const level = questionNumber <= 5 ? 1 : questionNumber <= 10 ? 2 : questionNumber <= 20 ? 3 : 4;

  let useDec;
  if (currentMode === 'random') {
    const decChance = questionNumber <= 5 ? 0.25 : questionNumber <= 10 ? 0.35 : 0.45;
    useDec = Math.random() < decChance;
  } else {
    useDec = true;
  }

  if (!useDec) {
    // ===== Integer problems =====
    if (level === 1) {
      switch (op) {
        case '+': a=rand(10,50); b=rand(1,9); answer=a+b; break;
        case '-': a=rand(10,50); b=rand(1,9); answer=a-b; break;
        case 'Ã—': a=rand(10,30); b=rand(2,5); answer=a*b; break;
        case 'Ã·': b=rand(2,5); answer=rand(2,9); a=answer*b; break;
      }
    } else if (level === 2) {
      switch (op) {
        case '+': a=rand(10,99); b=rand(10,99); answer=a+b; break;
        case '-': a=rand(10,99); b=rand(10,99); if(a<=b){const t=a;a=b;b=t;} answer=a-b; if(answer===0){a++;answer=a-b;} break;
        case 'Ã—': a=rand(10,99); b=rand(2,9); answer=a*b; break;
        case 'Ã·': b=rand(2,9); answer=rand(5,15); a=answer*b; break;
      }
    } else if (level === 3) {
      switch (op) {
        case '+': a=rand(100,999); b=rand(10,99); answer=a+b; break;
        case '-': a=rand(100,999); b=rand(10,99); answer=a-b; break;
        case 'Ã—': a=rand(30,99); b=rand(4,9); answer=a*b; break;
        case 'Ã·': b=rand(2,5); answer=rand(10,99); a=answer*b; break;
      }
    } else {
      switch (op) {
        case '+': a=rand(100,999); b=rand(100,999); answer=a+b; break;
        case '-': a=rand(100,999); b=rand(100,999); if(a<=b){const t=a;a=b;b=t;} answer=a-b; if(answer===0){a++;answer=a-b;} break;
        case 'Ã—': a=rand(50,99); b=rand(5,9); answer=a*b; break;
        case 'Ã·': b=rand(3,9); answer=rand(20,150); a=answer*b; break;
      }
    }
  } else {
    // ===== Decimal problems =====
    // For +/- : ~33% chance one operand is integer (int+dec combo)
    const useIntDec = (op === '+' || op === '-') && Math.random() < 0.33;
    // easyDec: multiplication always uses simple pattern (0.X Ã— Y)
    const mulLevel = (currentMode === 'easyDec') ? 1 : level;

    switch (op) {
      case '+':
        if (useIntDec) {
          if (level === 1) { a = rand(2, 9); b = rand(1, 9) / 10; }
          else if (level === 2) { a = rand(10, 50); b = rand(1, 9) / 10; }
          else if (level === 3) { a = rand(10, 99); b = rand(10, 99) / 100; }
          else { a = rand(100, 999); b = rand(10, 99) / 100; }
        } else {
          if (level === 1) {
            if (Math.random() < 0.5) { a = rand(1,9)/10; b = rand(1,9)/10; }
            else { a = rand(10,99)/10; b = rand(1,9)/10; }
          } else if (level === 2) {
            if (Math.random() < 0.5) { a = rand(10,99)/100; b = rand(1,9)/10; }
            else { a = rand(10,99)/10; b = rand(10,99)/100; }
          } else if (level === 3) {
            if (Math.random() < 0.5) { a = rand(100,999)/100; b = rand(10,99)/100; }
            else { a = rand(100,999)/10; b = rand(10,99)/100; }
          } else {
            if (Math.random() < 0.5) { a = rand(1000,9999)/100; b = rand(100,999)/100; }
            else { a = rand(100,999)/100; b = rand(100,999)/10; }
          }
        }
        answer = roundDec(a + b);
        break;

      case '-':
        if (useIntDec) {
          if (level === 1) { a = rand(2, 9); b = rand(1, 9) / 10; }
          else if (level === 2) { a = rand(10, 50); b = rand(1, 9) / 10; }
          else if (level === 3) { a = rand(10, 99); b = rand(10, 99) / 100; }
          else { a = rand(100, 999); b = rand(10, 99) / 100; }
        } else {
          if (level === 1) {
            if (Math.random() < 0.5) { a = rand(5,9)/10; b = rand(1,4)/10; }
            else { a = rand(10,99)/10; b = rand(1,9)/10; }
          } else if (level === 2) {
            if (Math.random() < 0.5) { a = rand(50,99)/100; b = rand(10,49)/100; }
            else { a = rand(10,99)/10; b = rand(10,99)/100; }
          } else if (level === 3) {
            if (Math.random() < 0.5) { a = rand(100,999)/100; b = rand(10,99)/100; }
            else { a = rand(100,999)/10; b = rand(10,99)/10; }
          } else {
            if (Math.random() < 0.5) { a = rand(100,999)/100; b = rand(100,999)/100; }
            else { a = rand(100,999)/10; b = rand(100,999)/100; }
          }
          if (a <= b) { const t = a; a = b; b = t; }
        }
        answer = roundDec(a - b);
        if (answer === 0) { a = roundDec(a + 0.1); answer = roundDec(a - b); }
        break;

      case 'Ã—':
        if (mulLevel === 1) {
          a = rand(1,9)/10; b = rand(2,9);
        } else if (mulLevel === 2) {
          if (Math.random() < 0.5) { a = rand(10,99)/100; b = rand(2,9)/10; }
          else { a = rand(10,99)/10; b = rand(2,9)/10; }
        } else if (mulLevel === 3) {
          if (Math.random() < 0.5) { a = rand(10,99)/100; b = rand(2,9)/10; }
          else { a = rand(10,99)/100; b = rand(2,9); }
        } else {
          if (Math.random() < 0.5) { a = rand(10,99)/100; b = rand(2,9)/10; }
          else { a = rand(1,9)/10; b = rand(2,9)/10; }
        }
        answer = roundDec(a * b);
        break;

      case 'Ã·':
        if (level === 1) {
          answer = rand(2,9);
          b = pick([0.2, 0.4, 0.5]);
        } else if (level === 2) {
          answer = rand(2,20);
          b = pick([0.2, 0.4, 0.5, 0.8, 0.25]);
        } else if (level === 3) {
          answer = rand(5,99)/10;
          b = pick([0.2, 0.4, 0.5, 0.8, 0.25]);
        } else {
          answer = rand(5,199)/10;
          b = pick([0.2, 0.4, 0.5, 0.8, 0.25]);
        }
        a = roundDec(answer * b);
        answer = roundDec(a / b);
        break;
    }
  }

  const display = `${formatNum(a)} ${op} ${formatNum(b)}`;
  return { display, answer };
}

// ==============================
// Game logic
// ==============================
function selectMode(mode) {
  currentMode = mode;
  if (mode === 'review') {
    reviewPool = getWrongProblems();
    if (reviewPool.length === 0) {
      alert('ã¾ã¡ãŒãˆãŸå•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
      return;
    }
  }
  startGame();
}

function startGame() {
  score = 0;
  timeLeft = 60.0;
  gameActive = true;

  document.getElementById('scoreDisplay').textContent = '0';
  document.getElementById('feedback').textContent = '';
  document.getElementById('feedback').className = 'feedback';
  document.getElementById('gameModeLabel').textContent = MODE_NAMES[currentMode] + 'ãƒ¢ãƒ¼ãƒ‰';

  showScreen('gameScreen');
  nextQuestion();
  startTimer();
  if (!isTouchDevice) document.getElementById('answerInput').focus();
}

function nextQuestion() {
  const questionNum = score + 1;
  let problem;

  if (currentMode === 'review') {
    if (reviewPool.length === 0) {
      // All review problems done - end game
      gameActive = false;
      endGame('reviewDone');
      return;
    }
    const idx = rand(0, reviewPool.length - 1);
    const wp = reviewPool.splice(idx, 1)[0];
    problem = parseReviewProblem(wp);
  } else {
    problem = generateProblem(questionNum);
  }

  currentAnswer = problem.answer;
  currentDisplay = problem.display;
  document.getElementById('questionBox').textContent = problem.display;
  document.getElementById('questionNum').textContent = questionNum;
  document.getElementById('answerInput').value = '';
  if (!isTouchDevice) document.getElementById('answerInput').focus();
}

function parseReviewProblem(wp) {
  // Parse the stored display string (e.g. "12 + 3.4") to get answer
  const parts = wp.display.split(' ');
  const a = parseFloat(parts[0]);
  const op = parts[1];
  const b = parseFloat(parts[2]);
  let answer;
  switch (op) {
    case '+': answer = roundDec(a + b); break;
    case '-': answer = roundDec(a - b); break;
    case 'Ã—': answer = roundDec(a * b); break;
    case 'Ã·': answer = roundDec(a / b); break;
    default: answer = parseFloat(wp.correctAnswer);
  }
  return { display: wp.display, answer };
}

function submitAnswer() {
  if (!gameActive) return;
  const input = document.getElementById('answerInput');
  const value = input.value.trim();
  if (value === '') return;

  const userAnswer = parseFloat(value);
  if (isNaN(userAnswer)) {
    input.value = '';
    return;
  }

  const feedbackEl = document.getElementById('feedback');

  if (Math.abs(userAnswer - currentAnswer) < 0.0005) {
    score++;
    timeLeft += 5;
    document.getElementById('scoreDisplay').textContent = score;
    feedbackEl.textContent = 'æ­£è§£ï¼ +5ç§’';
    feedbackEl.className = 'feedback correct';
    document.getElementById('questionBox').classList.remove('flash');
    void document.getElementById('questionBox').offsetWidth;
    document.getElementById('questionBox').classList.add('flash');
    // Track consecutive correct streak in review mode
    if (currentMode === 'review') {
      const wrongs = getWrongProblems();
      const matchIdx = wrongs.findIndex(w => w.display === currentDisplay);
      if (matchIdx !== -1) {
        wrongs[matchIdx].correctStreak = (wrongs[matchIdx].correctStreak || 0) + 1;
        if (wrongs[matchIdx].correctStreak >= 10) {
          wrongs.splice(matchIdx, 1);
        }
        localStorage.setItem(WRONG_KEY, JSON.stringify(wrongs));
      }
    }
    updateTimerDisplay();
    nextQuestion();
  } else {
    gameActive = false;
    feedbackEl.textContent = `ä¸æ­£è§£â€¦ ç­”ãˆã¯ ${formatNum(currentAnswer)}`;
    feedbackEl.className = 'feedback wrong';
    if (currentMode !== 'review') {
      saveWrongProblem(currentDisplay, userAnswer, currentAnswer);
    } else {
      // Reset streak on wrong answer in review mode
      const wrongs = getWrongProblems();
      const matchIdx = wrongs.findIndex(w => w.display === currentDisplay);
      if (matchIdx !== -1) {
        wrongs[matchIdx].correctStreak = 0;
        localStorage.setItem(WRONG_KEY, JSON.stringify(wrongs));
      }
    }
    setTimeout(() => endGame('wrong'), 800);
  }
}

function startTimer() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeLeft -= 0.1;
    updateTimerDisplay();
    if (timeLeft <= 0) {
      timeLeft = 0;
      updateTimerDisplay();
      gameActive = false;
      endGame('time');
    }
  }, 100);
}

function updateTimerDisplay() {
  const el = document.getElementById('timer');
  el.textContent = Math.max(0, timeLeft).toFixed(1);
  if (timeLeft <= 10) {
    el.classList.add('danger');
  } else {
    el.classList.remove('danger');
  }
}

function endGame(reason) {
  clearInterval(timerInterval);
  timerInterval = null;
  gameActive = false;

  saveResult(score);
  const history = getHistory(currentMode);
  const sorted = [...history].sort((a, b) => b.score - a.score);
  const rank = sorted.findIndex(h => h.score === score && h.date === history[history.length - 1].date) + 1;

  document.getElementById('resultScore').textContent = score;
  document.getElementById('resultRank').textContent = `æ­´ä»£ ${rank} ä½ / ${history.length} å›ä¸­`;
  document.getElementById('gameOverReason').textContent =
    reason === 'time' ? 'ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼' : reason === 'reviewDone' ? 'å¾©ç¿’å•é¡Œã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ï¼' : 'ä¸æ­£è§£ã§ã‚²ãƒ¼ãƒ çµ‚äº†';

  showScreen('resultScreen');
}

// Enter key to submit (desktop)
document.getElementById('answerInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    submitAnswer();
  }
});

// Mobile: prevent native keyboard, use custom numpad instead
if (isTouchDevice) {
  document.getElementById('answerInput').setAttribute('readonly', '');
}

// Numpad event handler
document.getElementById('numpad').addEventListener('click', (e) => {
  const btn = e.target.closest('.numpad-btn');
  if (!btn) return;
  const key = btn.dataset.key;
  const input = document.getElementById('answerInput');

  if (key === 'ok') {
    submitAnswer();
  } else if (key === 'del') {
    input.value = input.value.slice(0, -1);
  } else if (key === '.') {
    if (!input.value.includes('.')) input.value += '.';
  } else {
    input.value += key;
  }
});

// ==============================
// Ranking
// ==============================
function renderRanking() {
  const history = getHistory(rankingViewMode);
  const sorted = [...history].sort((a, b) => b.score - a.score).slice(0, 20);
  const list = document.getElementById('rankingList');

  if (sorted.length === 0) {
    list.innerHTML = '<li class="empty-message">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
    return;
  }

  list.innerHTML = sorted.map((item, i) => {
    const d = new Date(item.date);
    const dateStr = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
    const rankLabel = i < 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i] : `${i+1}`;
    return `
      <li class="ranking-item">
        <div class="rank ${rankClass}">${rankLabel}</div>
        <div class="info">
          <div class="date">${dateStr}</div>
        </div>
        <div class="score-val">${item.score} å•</div>
      </li>`;
  }).join('');
}

// ==============================
// Chart
// ==============================
// Init: show review button if needed
updateReviewButton();

function renderChart() {
  const history = getHistory(chartViewMode);
  const canvas = document.getElementById('historyChart');

  if (historyChart) {
    historyChart.destroy();
    historyChart = null;
  }

  if (history.length === 0) {
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#64748b';
    ctx.font = '14px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', canvas.width / 2, canvas.height / 2);
    return;
  }

  const recent = history.slice(-30);
  const labels = recent.map(h => {
    const d = new Date(h.date);
    return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  });
  const data = recent.map(h => h.score);

  historyChart = new Chart(canvas, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'é€£ç¶šæ­£è§£æ•°',
        data,
        borderColor: '#4f46e5',
        backgroundColor: 'rgba(79,70,229,0.1)',
        fill: true,
        tension: 0.3,
        pointBackgroundColor: '#4f46e5',
        pointRadius: 4,
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1, precision: 0 },
          title: { display: true, text: 'é€£ç¶šæ­£è§£æ•°' }
        },
        x: {
          ticks: { maxRotation: 45, font: { size: 10 } },
          title: { display: true, text: 'ãƒ—ãƒ¬ã‚¤æ—¥æ™‚' }
        }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });
}
</script>
</body>
</html>
